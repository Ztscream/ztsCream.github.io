[{"content":"Spring Boot äº‘åŸç”Ÿé™æµä¸ç›‘æ§å®è·µä½œä¸šè¯´æ˜ 1. ä½œä¸šè¯´æ˜ æœ¬é¡¹ç›®åŸºäº Spring Boot å¼€å‘ REST åº”ç”¨ï¼Œç»“åˆ Dockerã€Kubernetesã€Jenkinsã€Prometheusã€Grafana ç­‰äº‘åŸç”ŸæŠ€æœ¯ï¼Œå®Œæˆé™æµã€CI/CDã€ç›‘æ§ä¸å¼¹æ€§æ‰©å±•çš„å…¨æµç¨‹å®è·µ\nå§“å å­¦å· è”ç³»æ–¹å¼ ä¸ªäººè´¡çŒ® å¼ å ‚å‡ 231250137 13706811071 å…¨éƒ¨ 2. åŠŸèƒ½å¼€å‘ 2.1 å®ç° REST æ¥å£ ä»£ç ä½ç½®ï¼šsrc/main/java/io/daocloud/prometheustestdemo/PrometheusTestDemoController.java ``\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 package io.daocloud.prometheustestdemo; import com.google.common.util.concurrent.RateLimiter; import org.springframework.http.HttpStatus; import org.springframework.http.ResponseEntity; import org.springframework.web.bind.annotation.GetMapping; import org.springframework.web.bind.annotation.RequestMapping; import org.springframework.web.bind.annotation.RestController; import java.util.HashMap; import java.util.Map; @RestController @RequestMapping(\u0026#34;/\u0026#34;) // è¯Šæ–­æ€§æ·»åŠ ï¼šå°è¯•ä¸€ä¸ªæ ¹è·¯å¾„æ˜ å°„ public class PrometheusTestDemoController { // æ¯ç§’å…è®¸100ä¸ªè¯·æ±‚ private final RateLimiter rateLimiter = RateLimiter.create(100.0); @GetMapping(\u0026#34;/hello\u0026#34;) public ResponseEntity\u0026lt;Map\u0026lt;String, String\u0026gt;\u0026gt; hello() { if (!rateLimiter.tryAcquire()) { // å¦‚æœæœªèƒ½è·å–åˆ°ä»¤ç‰Œï¼Œè¡¨ç¤ºå·²è¾¾åˆ°é™æµï¼Œè¿”å›429 Too Many Requests return ResponseEntity.status(HttpStatus.TOO_MANY_REQUESTS).body(null); } Map\u0026lt;String, String\u0026gt; response = new HashMap\u0026lt;\u0026gt;(); response.put(\u0026#34;msg\u0026#34;, \u0026#34;hello\u0026#34;); return ResponseEntity.ok(response); } @GetMapping public ResponseEntity\u0026lt;Map\u0026lt;String, String\u0026gt;\u0026gt; root() { Map\u0026lt;String, String\u0026gt; response = new HashMap\u0026lt;\u0026gt;(); response.put(\u0026#34;msg\u0026#34;, \u0026#34;Welcome to root path\u0026#34;); return ResponseEntity.ok(response); } } ä½œç”¨ä¸åŸç†\nï¼š\nä½¿ç”¨ @RestController æ³¨è§£ï¼Œè‡ªåŠ¨æ³¨å†Œä¸º Spring Web æ§åˆ¶å™¨ã€‚ /hello æ¥å£é€šè¿‡ @GetMapping(\u0026quot;/hello\u0026quot;) æš´éœ²ï¼Œè¿”å›å›ºå®š JSONï¼š{\u0026quot;msg\u0026quot;: \u0026quot;hello\u0026quot;}ã€‚ æ ¹è·¯å¾„ / ä¹Ÿè¿”å›æ¬¢è¿ä¿¡æ¯ï¼Œä¾¿äºå¥åº·æ£€æŸ¥ã€‚ æµ‹è¯•æ–¹æ³•\nï¼š\nè®¿é—®\n1 http://\u0026lt;æœåŠ¡åœ°å€\u0026gt;:\u0026lt;ç«¯å£\u0026gt;/hello ï¼Œåº”è¿”å›ï¼š\n1 {\u0026#34;msg\u0026#34;: \u0026#34;hello\u0026#34;} â€‹ 2.2 å®ç°é™æµæ§åˆ¶ **\nä»£ç ä½ç½®**ï¼šåŒä¸Š Controller\nä½œç”¨ä¸åŸç†\nï¼š\né›†æˆ Guava çš„ RateLimiterï¼Œè®¾ç½®æ¯ç§’æœ€å¤§ 100 æ¬¡è¯·æ±‚ã€‚ æ¯æ¬¡è¯·æ±‚å…ˆ tryAcquire()ï¼Œæœªè·å–åˆ°ä»¤ç‰Œåˆ™ç›´æ¥è¿”å› 429 çŠ¶æ€ç ï¼ˆToo Many Requestsï¼‰ã€‚ æµ‹è¯•æ–¹æ³•\nï¼š\nå¹¶å‘å‹æµ‹ /hello æ¥å£ï¼Œéƒ¨åˆ†è¯·æ±‚åº”è¿”å› 429ã€‚\næ¨èå‹æµ‹å‘½ä»¤æˆ–è€…ä»¥ä¸‹test1.shï¼š\n1 seq 50000 | xargs -P 200 -I {} curl -s -o /dev/null -w \u0026#34;%{http_code}\\n\u0026#34; \u0026#34;http://\u0026lt;æœåŠ¡åœ°å€\u0026gt;:\u0026lt;ç«¯å£\u0026gt;/hello\u0026#34; | sort | uniq -c é¢„æœŸè¾“å‡ºï¼š200 å’Œ 429 çš„æ•°é‡ç»Ÿè®¡ã€‚\n2.3 æš´éœ² Prometheus æŒ‡æ ‡ ä¾èµ–é…ç½®ï¼špom.xml å¼•å…¥ spring-boot-starter-actuator å’Œ micrometer-registry-prometheusã€‚ ``\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;project xmlns=\u0026#34;http://maven.apache.org/POM/4.0.0\u0026#34; xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34; xsi:schemaLocation=\u0026#34;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\u0026#34;\u0026gt; \u0026lt;modelVersion\u0026gt;4.0.0\u0026lt;/modelVersion\u0026gt; \u0026lt;parent\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-parent\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.1.13.RELEASE\u0026lt;/version\u0026gt; \u0026lt;relativePath/\u0026gt; \u0026lt;!-- lookup parent from repository --\u0026gt; \u0026lt;/parent\u0026gt; \u0026lt;groupId\u0026gt;io.daocloud\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;prometheus-test-demo\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;0.0.1-SNAPSHOT\u0026lt;/version\u0026gt; \u0026lt;name\u0026gt;prometheus-test-demo\u0026lt;/name\u0026gt; \u0026lt;description\u0026gt;Demo project for Spring Boot\u0026lt;/description\u0026gt; \u0026lt;properties\u0026gt; \u0026lt;java.version\u0026gt;1.8\u0026lt;/java.version\u0026gt; \u0026lt;/properties\u0026gt; \u0026lt;dependencies\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-web\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-test\u0026lt;/artifactId\u0026gt; \u0026lt;scope\u0026gt;test\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-actuator\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;io.micrometer\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;micrometer-registry-prometheus\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.projectlombok\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;lombok\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.google.guava\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;guava\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;31.1-jre\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; \u0026lt;build\u0026gt; \u0026lt;plugins\u0026gt; \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-maven-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;/plugins\u0026gt; \u0026lt;/build\u0026gt; \u0026lt;repositories\u0026gt; \u0026lt;repository\u0026gt; \u0026lt;id\u0026gt;alimaven\u0026lt;/id\u0026gt; \u0026lt;name\u0026gt;aliyun maven\u0026lt;/name\u0026gt; \u0026lt;url\u0026gt;http://maven.aliyun.com/nexus/content/groups/public/\u0026lt;/url\u0026gt; \u0026lt;/repository\u0026gt; \u0026lt;/repositories\u0026gt; \u0026lt;pluginRepositories\u0026gt; \u0026lt;pluginRepository\u0026gt; \u0026lt;id\u0026gt;aliyun-plugin\u0026lt;/id\u0026gt; \u0026lt;url\u0026gt;http://maven.aliyun.com/nexus/content/groups/public/\u0026lt;/url\u0026gt; \u0026lt;snapshots\u0026gt; \u0026lt;enabled\u0026gt;false\u0026lt;/enabled\u0026gt; \u0026lt;/snapshots\u0026gt; \u0026lt;/pluginRepository\u0026gt; \u0026lt;/pluginRepositories\u0026gt; \u0026lt;/project\u0026gt; ä½œç”¨ä¸åŸç†\nï¼š\nSpring Boot Actuator è‡ªåŠ¨æš´éœ² /actuator/prometheusï¼ŒåŒ…å« HTTP QPSã€å“åº”æ—¶é—´ç­‰æŒ‡æ ‡ã€‚ å…³é”®æŒ‡æ ‡ï¼š http_server_requests_seconds_countï¼šæ¥å£è¯·æ±‚æ¬¡æ•°ï¼ˆå«çŠ¶æ€ç ã€æ–¹æ³•ç­‰æ ‡ç­¾ï¼‰ http_server_requests_seconds_sumï¼šæ¥å£å“åº”æ—¶é—´æ€»å’Œ æµ‹è¯•æ–¹æ³•\nï¼š\nè®¿é—® http://\u0026lt;æœåŠ¡åœ°å€\u0026gt;:\u0026lt;ç«¯å£\u0026gt;/actuator/prometheusï¼Œåº”çœ‹åˆ°ä¸Šè¿°æŒ‡æ ‡ã€‚ 3. DevOps æµæ°´çº¿æ„å»ºä¸éƒ¨ç½² 3.1 Dockerfile æ„å»ºé•œåƒ æ–‡ä»¶ï¼šDockerfile\nä½œç”¨ä¸åŸç†\nï¼š\nå¤šé˜¶æ®µæ„å»ºï¼Œå…ˆç”¨ Maven é•œåƒç¼–è¯‘ï¼Œå†ç”¨ JRE é•œåƒè¿è¡Œï¼Œå‡å°é•œåƒä½“ç§¯ã€‚ å¤åˆ¶æ‰“åŒ…å¥½çš„ JAR åˆ°è¿è¡Œç¯å¢ƒï¼Œè®¾ç½®å¯åŠ¨å‘½ä»¤ã€‚ æµ‹è¯•æ–¹æ³•\nï¼š\ndocker build -t prometheus-test-demo:latest . docker run -p 8998:8998 prometheus-test-demo:latest ``\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 # ç¬¬ä¸€é˜¶æ®µï¼šæ„å»ºé˜¶æ®µ FROM maven:3.8.7-eclipse-temurin-8 AS builder # è®¾ç½®å·¥ä½œç›®å½• WORKDIR /usr/src/mymaven # å¤åˆ¶ Maven é…ç½®æ–‡ä»¶ RUN mkdir -p /root/.m2 COPY settings.xml /root/.m2/settings.xml # å¤åˆ¶pom.xmlå’Œæºä»£ç  COPY pom.xml . RUN mvn dependency:go-offline COPY src ./src # æ„å»ºé¡¹ç›® RUN mvn -B -DskipTests clean package # ç¬¬äºŒé˜¶æ®µï¼šè¿è¡Œé˜¶æ®µ FROM eclipse-temurin:8u372-b07-jre-centos7 # è®¾ç½®æ—¶åŒº RUN ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime RUN echo \u0026#39;Asia/Shanghai\u0026#39; \u0026gt;/etc/timezone # è®¾ç½®ç¯å¢ƒå˜é‡ ENV JAVA_OPTS \u0026#39;\u0026#39; # è®¾ç½®å·¥ä½œç›®å½• WORKDIR /app # ä»æ„å»ºé˜¶æ®µå¤åˆ¶æ„å»ºç»“æœ COPY --from=builder /usr/src/mymaven/target/prometheus-test-demo-0.0.1-SNAPSHOT.jar ./prometheus-test-demo-0.0.1-SNAPSHOT.jar # å¯åŠ¨å‘½ä»¤ ENTRYPOINT [\u0026#34;sh\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;set -e \u0026amp;\u0026amp; java -XX:+PrintFlagsFinal \\ -XX:+HeapDumpOnOutOfMemoryError \\ -XX:HeapDumpPath=/heapdump/heapdump.hprof \\ -XX:+UnlockExperimentalVMOptions \\ -XX:+UseCGroupMemoryLimitForHeap \\ $JAVA_OPTS -jar prometheus-test-demo-0.0.1-SNAPSHOT.jar\u0026#34;] 3.2 Kubernetes YAML æ–‡ä»¶ æ–‡ä»¶ï¼šjenkins/scripts/prometheus-test-demo.yamlã€prometheus-test-serviceMonitor.yaml ``\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 apiVersion: apps/v1 kind: Deployment metadata: labels: app: prometheus-test-demo name: prometheus-test-demo namespace: {NAMESPACE} spec: replicas: 2 selector: matchLabels: app: prometheus-test-demo template: metadata: annotations: prometheus.io/path: /actuator/prometheus prometheus.io/port: \u0026#34;8998\u0026#34; prometheus.io/scheme: http prometheus.io/scrape: \u0026#34;true\u0026#34; labels: app: prometheus-test-demo spec: containers: - image: 172.22.83.19:30003/nju05/prometheus-test-demo:{VERSION} name: prometheus-test-demo imagePullPolicy: IfNotPresent resources: limits: cpu: \u0026#34;500m\u0026#34; memory: \u0026#34;512Mi\u0026#34; requests: cpu: \u0026#34;200m\u0026#34; memory: \u0026#34;256Mi\u0026#34; --- apiVersion: v1 kind: Service metadata: name: prometheus-test-demo labels: app: prometheus-test-demo namespace: {NAMESPACE} spec: type: NodePort selector: app: prometheus-test-demo ports: - name: tcp protocol: TCP port: 8998 targetPort: 8998 ``\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 apiVersion: monitoring.coreos.com/v1 kind: ServiceMonitor metadata: labels: k8s-app: prometheus-test-demo name: prometheus-test-demo namespace: {MONITOR_NAMESPACE} spec: endpoints: - interval: 30s port: tcp path: /actuator/prometheus scheme: \u0026#39;http\u0026#39; selector: matchLabels: app: prometheus-test-demo namespaceSelector: matchNames: - {NAMESPACE} ä½œç”¨ä¸åŸç†\nï¼š\nDeploymentï¼šå®šä¹‰å‰¯æœ¬æ•°ã€é•œåƒã€ç«¯å£ã€èµ„æºé™åˆ¶ç­‰ã€‚ Serviceï¼šæš´éœ² NodePort ç«¯å£ï¼Œä¾›å¤–éƒ¨è®¿é—®ã€‚ ServiceMonitorï¼šPrometheus è‡ªåŠ¨å‘ç°å¹¶é‡‡é›† /actuator/prometheus æŒ‡æ ‡ã€‚ æµ‹è¯•æ–¹æ³•\nï¼š\nkubectl apply -f prometheus-test-demo.yaml kubectl apply -f prometheus-test-serviceMonitor.yaml kubectl get svc æŸ¥çœ‹æœåŠ¡ç«¯å£ 3.3 Jenkins CI/CD æµæ°´çº¿ æ–‡ä»¶ï¼šJenkinsfile ``\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 pipeline { agent none // ç¯å¢ƒå˜é‡ç®¡ç† environment { HARBOR_REGISTRY = \u0026#39;172.22.83.19:30003\u0026#39; IMAGE_NAME = \u0026#39;nju05/prometheus-test-demo\u0026#39; GIT_REPO = \u0026#39;https://gitee.com/ztsCream/prometheus-test-demo.git\u0026#39; NAMESPACE = \u0026#39;nju05\u0026#39; MONITOR_NAMESPACE = \u0026#39;nju05\u0026#39; HARBOR_USER = \u0026#39;nju05\u0026#39; } parameters { string(name: \u0026#39;HARBOR_PASS\u0026#39;, defaultValue: \u0026#39;\u0026#39;, description: \u0026#39;Harbor login password\u0026#39;) } stages { stage(\u0026#39;Clone Code\u0026#39;) { agent { label \u0026#39;master\u0026#39; } steps { echo \u0026#34;1.Git Clone Code\u0026#34; script { try { git url: \u0026#34;${env.GIT_REPO}\u0026#34; } catch (Exception e) { error \u0026#34;Git clone failed: ${e.getMessage()}\u0026#34; } } } } stage(\u0026#39;Maven Test\u0026#39;) { agent { docker { image \u0026#39;maven:3-alpine\u0026#39; args \u0026#39;-v /root/.m2:/root/.m2\u0026#39; } } steps { echo \u0026#34;2. Maven Test Stage\u0026#34; script { try { sh \u0026#34;mvn test\u0026#34; } catch (Exception e) { error \u0026#34;Maven test failed: ${e.getMessage()}\u0026#34; } } } } stage(\u0026#39;Check JAR Content\u0026#39;) { agent { docker { image \u0026#39;maven:3-alpine\u0026#39; args \u0026#39;-v /root/.m2:/root/.m2\u0026#39; } } steps { echo \u0026#34;æ£€æŸ¥ JAR åŒ…æ˜¯å¦åŒ…å« PrometheusTestDemoController.class\u0026#34; sh \u0026#39;mvn clean package -DskipTests\u0026#39; sh \u0026#39;jar tf target/prometheus-test-demo-0.0.1-SNAPSHOT.jar | grep PrometheusTestDemoController || echo \u0026#34;NOT FOUND\u0026#34;\u0026#39; } } stage(\u0026#39;Image Build\u0026#39;) { agent { label \u0026#39;master\u0026#39; } steps { echo \u0026#34;2.Image Build Stage (åŒ…å« Maven æ„å»º)\u0026#34; script { try { // ä½¿ç”¨ Dockerfile å¤šé˜¶æ®µæ„å»ºï¼ŒåŒ…å« Maven æ„å»ºå’Œé•œåƒæ„å»º sh \u0026#34;docker build --no-cache --cache-from ${env.HARBOR_REGISTRY}/${env.IMAGE_NAME}:latest -t ${env.HARBOR_REGISTRY}/${env.IMAGE_NAME}:${BUILD_NUMBER} -t ${env.HARBOR_REGISTRY}/${env.IMAGE_NAME}:latest .\u0026#34; } catch (Exception e) { error \u0026#34;Docker build failed: ${e.getMessage()}\u0026#34; } } } } stage(\u0026#39;Push\u0026#39;) { agent { label \u0026#39;master\u0026#39; } steps { echo \u0026#34;3.Push Docker Image Stage\u0026#34; script { try { sh \u0026#34;echo \u0026#39;${HARBOR_PASS}\u0026#39; | docker login --username=${HARBOR_USER} --password-stdin ${env.HARBOR_REGISTRY}\u0026#34; sh \u0026#34;docker push ${env.HARBOR_REGISTRY}/${env.IMAGE_NAME}:${BUILD_NUMBER}\u0026#34; sh \u0026#34;docker push ${env.HARBOR_REGISTRY}/${env.IMAGE_NAME}:latest\u0026#34; } catch (Exception e) { error \u0026#34;Docker push failed: ${e.getMessage()}\u0026#34; } } } } stage(\u0026#39;Deploy to Kubernetes\u0026#39;) { agent { label \u0026#39;slave\u0026#39; } steps { container(\u0026#39;jnlp-kubectl\u0026#39;) { script { stage(\u0026#39;Clone YAML\u0026#39;) { echo \u0026#34;4. Git Clone YAML To Slave\u0026#34; try { // ä½¿ç”¨ checkout scm è·å–å½“å‰æµæ°´çº¿çš„æºä»£ç  checkout scm } catch (Exception e) { error \u0026#34;Git clone on slave failed: ${e.getMessage()}\u0026#34; } } stage(\u0026#39;Config YAML\u0026#39;) { echo \u0026#34;5. Change YAML File Stage\u0026#34; sh \u0026#39;sed -i \u0026#34;s/{VERSION}/${BUILD_NUMBER}/g\u0026#34; ./jenkins/scripts/prometheus-test-demo.yaml\u0026#39; sh \u0026#39;sed -i \u0026#34;s/{NAMESPACE}/${NAMESPACE}/g\u0026#34; ./jenkins/scripts/prometheus-test-demo.yaml\u0026#39; sh \u0026#39;sed -i \u0026#34;s/{MONITOR_NAMESPACE}/${MONITOR_NAMESPACE}/g\u0026#34; ./jenkins/scripts/prometheus-test-serviceMonitor.yaml\u0026#39; sh \u0026#39;sed -i \u0026#34;s/{NAMESPACE}/${NAMESPACE}/g\u0026#34; ./jenkins/scripts/prometheus-test-serviceMonitor.yaml\u0026#39; sh \u0026#39;cat ./jenkins/scripts/prometheus-test-demo.yaml\u0026#39; sh \u0026#39;cat ./jenkins/scripts/prometheus-test-serviceMonitor.yaml\u0026#39; } stage(\u0026#39;Deploy prometheus-test-demo\u0026#39;) { echo \u0026#34;6. Deploy To K8s Stage\u0026#34; sh \u0026#39;kubectl apply -f ./jenkins/scripts/prometheus-test-demo.yaml\u0026#39; } stage(\u0026#39;Deploy prometheus-test-demo ServiceMonitor\u0026#39;) { echo \u0026#34;7. Deploy ServiceMonitor To K8s Stage\u0026#34; try { sh \u0026#39;kubectl apply -f ./jenkins/scripts/prometheus-test-serviceMonitor.yaml\u0026#39; } catch (Exception e) { error \u0026#34;ServiceMonitor deployment failed: ${e.getMessage()}\u0026#34; } } stage(\u0026#39;Health Check\u0026#39;) { echo \u0026#34;8. Health Check Stage\u0026#34; try { sh \u0026#34;kubectl wait --for=condition=ready pod -l app=prometheus-test-demo -n ${NAMESPACE} --timeout=300s\u0026#34; echo \u0026#34;Application is healthy and ready!\u0026#34; } catch (Exception e) { error \u0026#34;Health check failed: ${e.getMessage()}\u0026#34; } } } } } } } // é€šçŸ¥æœºåˆ¶å’Œæ¸…ç† post { success { echo \u0026#39;ğŸ‰ Pipeline succeeded! Application deployed successfully.\u0026#39; script { echo \u0026#34;âœ… Deployment Summary:\u0026#34; echo \u0026#34; - Image: ${env.HARBOR_REGISTRY}/${env.IMAGE_NAME}:${BUILD_NUMBER}\u0026#34; echo \u0026#34; - Namespace: ${NAMESPACE}\u0026#34; echo \u0026#34; - Monitor Namespace: ${MONITOR_NAMESPACE}\u0026#34; } } failure { echo \u0026#39;âŒ Pipeline failed! Please check the logs for details.\u0026#39; } always { echo \u0026#39;ğŸ”„ Pipeline execution completed.\u0026#39; // æ¸…ç†æœ¬åœ°é•œåƒä»¥èŠ‚çœç£ç›˜ç©ºé—´ script { node(\u0026#39;master\u0026#39;) { // ç¡®ä¿åœ¨masterèŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼Œå¹¶æä¾›FilePathä¸Šä¸‹æ–‡ try { sh \u0026#34;docker rmi ${env.HARBOR_REGISTRY}/${env.IMAGE_NAME}:${BUILD_NUMBER} || true\u0026#34; sh \u0026#34;docker rmi ${env.HARBOR_REGISTRY}/${env.IMAGE_NAME}:latest || true\u0026#34; sh \u0026#34;docker system prune -f || true\u0026#34; } catch (Exception e) { echo \u0026#34;Image cleanup failed: ${e.getMessage()}\u0026#34; } } } } } } ä½œç”¨ä¸åŸç†\nï¼š\nCI é˜¶æ®µï¼šæ‹‰å–ä»£ç ã€Maven æ„å»ºã€å•å…ƒæµ‹è¯•ã€æ„å»ºå¹¶æ¨é€ Docker é•œåƒåˆ° Harborã€‚ CD é˜¶æ®µï¼šæ‹‰å–é•œåƒã€kubectl apply éƒ¨ç½²åˆ° K8sï¼Œæ£€æŸ¥éƒ¨ç½²çŠ¶æ€ã€‚ æµ‹è¯•æ–¹æ³•\nï¼š\nJenkins æ–°å»º Pipelineï¼Œé…ç½®æºç å’Œå‡­æ®ï¼Œè¿è¡Œæµæ°´çº¿ã€‚ æ—¥å¿—ä¸­åº”çœ‹åˆ°æ„å»ºã€æ¨é€ã€éƒ¨ç½²ã€å¥åº·æ£€æŸ¥ç­‰æ­¥éª¤ã€‚ 4. ç›‘æ§ä¸å¼¹æ€§æ‰©å±•å®è·µ 4.1 Prometheus æŒ‡æ ‡é‡‡é›† åŸç†\nï¼š\nServiceMonitor è®© Prometheus è‡ªåŠ¨å‘ç° K8s æœåŠ¡ï¼Œé‡‡é›† /actuator/prometheusã€‚ æµ‹è¯•æ–¹æ³•\nï¼š\nPrometheus UI æŸ¥è¯¢ http_server_requests_seconds_count ç­‰æŒ‡æ ‡ã€‚ 4.2 Grafana ç›‘æ§é¢æ¿ åŸç†\nï¼š\né€šè¿‡ Prometheus æ•°æ®æºï¼Œåˆ›å»º Dashboard å±•ç¤º CPUã€å†…å­˜ã€JVMã€QPSã€å“åº”æ—¶é—´ç­‰ã€‚ æµ‹è¯•æ–¹æ³•\nï¼š\nGrafana æ–°å»º Dashboardï¼Œæ·»åŠ ç›¸å…³å›¾è¡¨ã€‚ å‚è€ƒæŒ‡æ ‡ï¼šprocess_cpu_usageã€jvm_memory_used_bytesã€http_server_requests_seconds_count ç­‰ã€‚ 4.3 å‹æµ‹ä¸ç›‘æ§éªŒè¯ æ–¹æ³•\nï¼š\nä½¿ç”¨å¹¶å‘ curl æˆ– ab å·¥å…·å‹æµ‹ /helloã€‚ åœ¨ Grafana é¢æ¿è§‚å¯Ÿ QPSã€å“åº”æ—¶é—´ã€429 é”™è¯¯ç‡ç­‰å˜åŒ–ã€‚ é¢„æœŸç°è±¡\nï¼š\nQPS å³°å€¼æ¥è¿‘ 100ï¼Œè¶…å‡ºéƒ¨åˆ†å‡ºç° 429ã€‚ JVMã€CPUã€å†…å­˜ç­‰æŒ‡æ ‡éšè´Ÿè½½å˜åŒ–ã€‚ 5. å…³é”®ä»£ç ä¸é…ç½®è¯´æ˜ 5.1 Controller é™æµæ ¸å¿ƒä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 @RestController @RequestMapping(\u0026#34;/\u0026#34;) public class PrometheusTestDemoController { private final RateLimiter rateLimiter = RateLimiter.create(100.0); @GetMapping(\u0026#34;/hello\u0026#34;) public ResponseEntity\u0026lt;Map\u0026lt;String, String\u0026gt;\u0026gt; hello() { if (!rateLimiter.tryAcquire()) { return ResponseEntity.status(HttpStatus.TOO_MANY_REQUESTS).body(null); } Map\u0026lt;String, String\u0026gt; response = new HashMap\u0026lt;\u0026gt;(); response.put(\u0026#34;msg\u0026#34;, \u0026#34;hello\u0026#34;); return ResponseEntity.ok(response); } } å®ç°åŸç†ï¼šGuava RateLimiter æ§åˆ¶æ¯ç§’æœ€å¤§è¯·æ±‚æ•°ï¼Œè¶…é™å³è¿”å› 429ã€‚ 5.2 Prometheus æŒ‡æ ‡æš´éœ² ä¾èµ–\nï¼š\n1 2 3 4 5 6 7 8 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-actuator\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;io.micrometer\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;micrometer-registry-prometheus\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; é…ç½®\nï¼š\n1 application.properties å¢åŠ \n1 2 3 4 management.endpoints.web.exposure.include=* management.endpoint.prometheus.enabled=true management.metrics.export.prometheus.enabled=true server.port=8998 5.3 Dockerfile ç¤ºä¾‹ 1 2 3 4 5 6 7 8 9 FROM maven:3.8.5-openjdk-8 AS build WORKDIR /app COPY . . RUN mvn clean package -DskipTests FROM openjdk:8-jre-alpine WORKDIR /app COPY --from=build /app/target/*.jar app.jar EXPOSE 8998 ENTRYPOINT [\u0026#34;java\u0026#34;, \u0026#34;-jar\u0026#34;, \u0026#34;app.jar\u0026#34;] 5.4 K8s Deployment ç‰‡æ®µ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 apiVersion: apps/v1 kind: Deployment metadata: name: prometheus-test-demo spec: replicas: 2 selector: matchLabels: app: prometheus-test-demo template: metadata: labels: app: prometheus-test-demo spec: containers: - name: app image: \u0026lt;Harboråœ°å€\u0026gt;/library/prometheus-test-demo:{VERSION} ports: - containerPort: 8998 resources: limits: cpu: \u0026#34;1\u0026#34; memory: \u0026#34;512Mi\u0026#34; requests: cpu: \u0026#34;0.2\u0026#34; memory: \u0026#34;128Mi\u0026#34; 5.5 Jenkinsfile ç‰‡æ®µ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 pipeline { agent any stages { stage(\u0026#39;Build\u0026#39;) { steps { sh \u0026#39;mvn clean package -DskipTests\u0026#39; } } stage(\u0026#39;Docker Build \u0026amp; Push\u0026#39;) { steps { sh \u0026#39;docker build -t \u0026lt;Harboråœ°å€\u0026gt;/library/prometheus-test-demo:${BUILD_NUMBER} .\u0026#39; sh \u0026#39;docker push \u0026lt;Harboråœ°å€\u0026gt;/library/prometheus-test-demo:${BUILD_NUMBER}\u0026#39; } } stage(\u0026#39;Deploy to K8s\u0026#39;) { steps { sh \u0026#39;kubectl apply -f jenkins/scripts/prometheus-test-demo.yaml\u0026#39; } } } } 5.6 ServiceMonitor ç‰‡æ®µ 1 2 3 4 5 6 7 8 9 10 11 12 apiVersion: monitoring.coreos.com/v1 kind: ServiceMonitor metadata: name: prometheus-test-demo spec: selector: matchLabels: app: prometheus-test-demo endpoints: - port: http path: /actuator/prometheus interval: 30s 6. æµ‹è¯•æˆåŠŸåçš„è¿”å›ç¤ºä¾‹ è®¿é—®\n1 /hello ï¼š\n1 {\u0026#34;msg\u0026#34;: \u0026#34;hello\u0026#34;} å¹¶å‘å‹æµ‹åç»Ÿè®¡ï¼š\n1 2 12345 200 37655 429 è®¿é—®\n1 /actuator/prometheus ï¼š\n1 2 3 4 # HELP http_server_requests_seconds_count ... http_server_requests_seconds_count{...method=\u0026#34;GET\u0026#34;,uri=\u0026#34;/hello\u0026#34;,status=\u0026#34;200\u0026#34;...} 12345 http_server_requests_seconds_count{...method=\u0026#34;GET\u0026#34;,uri=\u0026#34;/hello\u0026#34;,status=\u0026#34;429\u0026#34;...} 37655 ... 7. æ€»ç»“ æœ¬é¡¹ç›®å®Œæ•´å®ç°äº† REST æ¥å£ã€é™æµã€Prometheus æŒ‡æ ‡æš´éœ²ã€Docker é•œåƒã€K8s éƒ¨ç½²ã€Jenkins CI/CDã€ServiceMonitor è‡ªåŠ¨é‡‡é›†ã€Grafana ç›‘æ§ç­‰äº‘åŸç”Ÿå…¨æµç¨‹ã€‚æ‰€æœ‰åŠŸèƒ½å‡å¯é€šè¿‡å®é™…è®¿é—®å’Œç›‘æ§é¢æ¿éªŒè¯ã€‚\n","date":"0001-01-01T00:00:00Z","permalink":"https://ztsCream.github.io/p/","title":""},{"content":"åœ¨ Minikube ä¸Šéƒ¨ç½² Eureka å¾®æœåŠ¡æ¶æ„ æœ¬æŒ‡å—è¯¦ç»†è¯´æ˜å¦‚ä½•ä½¿ç”¨ Spring Boot å¼€å‘ Eureka Serverã€Admin Service å’Œ User Service ä¸‰ä¸ªå¾®æœåŠ¡ï¼Œå¹¶é€šè¿‡ Docker å’Œ Kubernetesï¼ˆMinikubeï¼‰éƒ¨ç½²ã€‚åŒ…æ‹¬æœåŠ¡æ³¨å†Œã€API å¼€å‘ã€Docker é•œåƒæ„å»ºå’Œ Kubernetes éƒ¨ç½²çš„å®Œæ•´æ­¥éª¤ã€‚\nç¯å¢ƒå‡†å¤‡ å‡è®¾æ‚¨åœ¨ minikube-user@iZgc71t4gsaxrqcyesrotqZ:~$ ç¯å¢ƒä¸‹æ“ä½œï¼Œå¹¶å·²å®‰è£…ä»¥ä¸‹å·¥å…·ï¼š\nJava 17 Maven Docker kubectl Minikube éªŒè¯ç¯å¢ƒ è¿è¡Œä»¥ä¸‹å‘½ä»¤ç¡®è®¤ç¯å¢ƒï¼š\n1 2 3 4 5 java -version # åº”æ˜¾ç¤º Java 17 mvn -v # åº”æ˜¾ç¤º Maven ç‰ˆæœ¬ docker --version # åº”æ˜¾ç¤º Docker ç‰ˆæœ¬ minikube status # ç¡®ä¿ Minikube è¿è¡Œ kubectl version # ç¡®è®¤ kubectl å·²å®‰è£… è‹¥ç¼ºå°‘å·¥å…·ï¼Œå®‰è£…ç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 # å®‰è£… Java 17 sudo apt update sudo apt install openjdk-17-jdk # å®‰è£… Maven sudo apt install maven # å®‰è£… Docker sudo apt install docker.io sudo usermod -aG docker minikube-user å¯åŠ¨ Minikubeï¼ˆè‹¥æœªå¯åŠ¨ï¼‰ï¼š\n1 minikube start é…ç½® Minikube ä½¿ç”¨æœ¬åœ° Dockerï¼š\n1 eval $(minikube docker-env) æ­¥éª¤ 1ï¼šåˆ›å»º Spring Boot é¡¹ç›® ä¸º Eureka Serverã€Admin Service å’Œ User Service åˆ›å»ºä¸‰ä¸ªç‹¬ç«‹é¡¹ç›®ã€‚\n1.1 é¡¹ç›®ç›®å½•ç»“æ„ 1 mkdir -p ~/eureka-server ~/admin-service ~/user-service 1.2 Eureka Server ç”Ÿæˆé¡¹ç›®ï¼š\n1 2 cd ~/eureka-server mvn archetype:generate -DgroupId=com.example.eureka -DartifactId=eureka-server -DarchetypeArtifactId=maven-archetype-quickstart -DinteractiveMode=false POM æ–‡ä»¶ï¼ˆ~/eureka-server/pom.xmlï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;project xmlns=\u0026#34;http://maven.apache.org/POM/4.0.0\u0026#34; xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34; xsi:schemaLocation=\u0026#34;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\u0026#34;\u0026gt; \u0026lt;modelVersion\u0026gt;4.0.0\u0026lt;/modelVersion\u0026gt; \u0026lt;groupId\u0026gt;com.example.eureka\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;eureka-server\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;0.0.1-SNAPSHOT\u0026lt;/version\u0026gt; \u0026lt;name\u0026gt;eureka-server\u0026lt;/name\u0026gt; \u0026lt;parent\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-parent\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.2.5\u0026lt;/version\u0026gt; \u0026lt;relativePath/\u0026gt; \u0026lt;/parent\u0026gt; \u0026lt;dependencies\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.cloud\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-cloud-starter-netflix-eureka-server\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-test\u0026lt;/artifactId\u0026gt; \u0026lt;scope\u0026gt;test\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; \u0026lt;dependencyManagement\u0026gt; \u0026lt;dependencies\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.cloud\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-cloud-dependencies\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2023.0.3\u0026lt;/version\u0026gt; \u0026lt;type\u0026gt;pom\u0026lt;/type\u0026gt; \u0026lt;scope\u0026gt;import\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; \u0026lt;/dependencyManagement\u0026gt; \u0026lt;build\u0026gt; \u0026lt;plugins\u0026gt; \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-maven-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;/plugins\u0026gt; \u0026lt;/build\u0026gt; \u0026lt;/project\u0026gt; ä¸»ç±»ï¼ˆ~/eureka-server/src/main/java/com/example/eureka/EurekaServerApplication.javaï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 package com.example.eureka; import org.springframework.boot.SpringApplication; import org.springframework.boot.autoconfigure.SpringBootApplication; import org.springframework.cloud.client.discovery.EnableDiscoveryClient; @SpringBootApplication @EnableDiscoveryClient public class EurekaServerApplication { public static void main(String[] args) { SpringApplication.run(EurekaServerApplication.class, args); } } é…ç½®æ–‡ä»¶ï¼ˆ~/eureka-server/src/main/resources/application.ymlï¼‰ï¼š\n1 2 3 4 5 6 7 8 server: port: 8761 eureka: instance: hostname: eureka-service client: register-with-eureka: false fetch-registry: false 1.3 Admin Service ç”Ÿæˆé¡¹ç›®ï¼š\n1 2 cd ~/admin-service mvn archetype:generate -DgroupId=com.example.admin -DartifactId=admin-service -DarchetypeArtifactId=maven-archetype-quickstart -DinteractiveMode=false POM æ–‡ä»¶ï¼ˆ~/admin-service/pom.xmlï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;project xmlns=\u0026#34;http://maven.apache.org/POM/4.0.0\u0026#34; xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34; xsi:schemaLocation=\u0026#34;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\u0026#34;\u0026gt; \u0026lt;modelVersion\u0026gt;4.0.0\u0026lt;/modelVersion\u0026gt; \u0026lt;groupId\u0026gt;com.example.admin\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;admin-service\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;0.0.1-SNAPSHOT\u0026lt;/version\u0026gt; \u0026lt;name\u0026gt;admin-service\u0026lt;/name\u0026gt; \u0026lt;parent\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-parent\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.2.5\u0026lt;/version\u0026gt; \u0026lt;relativePath/\u0026gt; \u0026lt;/parent\u0026gt; \u0026lt;dependencies\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-web\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.cloud\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-cloud-starter-netflix-eureka-client\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-validation\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-test\u0026lt;/artifactId\u0026gt; \u0026lt;scope\u0026gt;test\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; \u0026lt;dependencyManagement\u0026gt; \u0026lt;dependencies\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.cloud\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-cloud-dependencies\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2023.0.3\u0026lt;/version\u0026gt; \u0026lt;type\u0026gt;pom\u0026lt;/type\u0026gt; \u0026lt;scope\u0026gt;import\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; \u0026lt;/dependencyManagement\u0026gt; \u0026lt;build\u0026gt; \u0026lt;plugins\u0026gt; \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-maven-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;/plugins\u0026gt; \u0026lt;/build\u0026gt; \u0026lt;/project\u0026gt; ä¸»ç±»ï¼ˆ~/admin-service/src/main/java/com/example/admin/AdminServiceApplication.javaï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 package com.example.admin; import org.springframework.boot.SpringApplication; import org.springframework.boot.autoconfigure.SpringBootApplication; import org.springframework.cloud.client.loadbalancer.LoadBalanced; import org.springframework.cloud.client.discovery.EnableDiscoveryClient; import org.springframework.context.annotation.Bean; import org.springframework.web.client.RestTemplate; @SpringBootApplication @EnableDiscoveryClient public class AdminServiceApplication { public static void main(String[] args) { SpringApplication.run(AdminServiceApplication.class, args); } @Bean @LoadBalanced public RestTemplate restTemplate() { return new RestTemplate(); } } æ§åˆ¶å™¨ï¼ˆ~/admin-service/src/main/java/com/example/admin/controller/UserController.javaï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 package com.example.admin.controller; import jakarta.validation.constraints.NotBlank; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.http.ResponseEntity; import org.springframework.web.bind.annotation.PostMapping; import org.springframework.web.bind.annotation.RequestBody; import org.springframework.web.bind.annotation.RequestMapping; import org.springframework.web.bind.annotation.RestController; import org.springframework.web.client.RestTemplate; @RestController @RequestMapping(\u0026#34;/api/admin\u0026#34;) public class UserController { @Autowired private RestTemplate restTemplate; @PostMapping(\u0026#34;/users\u0026#34;) public ResponseEntity\u0026lt;String\u0026gt; addUser(@RequestBody UserDTO userDTO) { if (userDTO.getUsername() == null || userDTO.getUsername().isEmpty() || userDTO.getPassword() == null || userDTO.getPassword().isEmpty()) { return ResponseEntity.badRequest().body(\u0026#34;ç”¨æˆ·åæˆ–å¯†ç ä¸èƒ½ä¸ºç©º\u0026#34;); } String userServiceUrl = \u0026#34;http://user-service/api/users\u0026#34;; ResponseEntity\u0026lt;String\u0026gt; response = restTemplate.postForEntity(userServiceUrl, userDTO, String.class); return ResponseEntity.ok(response.getBody()); } public static class UserDTO { @NotBlank(message = \u0026#34;ç”¨æˆ·åä¸èƒ½ä¸ºç©º\u0026#34;) private String username; @NotBlank(message = \u0026#34;å¯†ç ä¸èƒ½ä¸ºç©º\u0026#34;) private String password; public String getUsername() { return username; } public void setUsername(String username) { this.username = username; } public String getè¼¸å…¥password() { return password; } public void setPassword(String password) { this.password = password; } } } é…ç½®æ–‡ä»¶ï¼ˆ~/admin-service/src/main/resources/application.ymlï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 server: port: 8081 spring: application: name: admin-service eureka: client: service-url: defaultZone: http://eureka-service:8761/eureka/ 1.4 User Service ç”Ÿæˆé¡¹ç›®ï¼š\n1 2 cd ~/user-service mvn archetype:generate -DgroupId=com.example.user -DartifactId=user-service -DarchetypeArtifactId=maven-archetype-quickstart -DinteractiveMode=false POM æ–‡ä»¶ï¼ˆ~/user-service/pom.xmlï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;project xmlns=\u0026#34;http://maven.apache.org/POM/4.0.0\u0026#34; xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34; xsi:schemaLocation=\u0026#34;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\u0026#34;\u0026gt; \u0026lt;modelVersion\u0026gt;4.0.0\u0026lt;/modelVersion\u0026gt; \u0026lt;groupId\u0026gt;com.example.user\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;user-service\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;0.0.1-SNAPSHOT\u0026lt;/version\u0026gt; \u0026lt;name\u0026gt;user-service\u0026lt;/name\u0026gt; \u0026lt;parent\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-parent\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.2.5\u0026lt;/version\u0026gt; \u0026lt;relativePath/\u0026gt; \u0026lt;/parent\u0026gt; \u0026lt;dependencies\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-web\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.cloud\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-cloud-starter-netflix-eureka-client\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-data-jpa\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.h2database\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;h2\u0026lt;/artifactId\u0026gt; \u0026lt;scope\u0026gt;runtime\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-test\u0026lt;/artifactId\u0026gt; \u0026lt;scope\u0026gt;test\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; \u0026lt;dependencyManagement\u0026gt; \u0026lt;dependencies\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.cloud\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-cloud-dependencies\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2023.0.3\u0026lt;/version\u0026gt; \u0026lt;type\u0026gt;pom\u0026lt;/type\u0026gt; \u0026lt;scope\u0026gt;import\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; \u0026lt;/dependencyManagement\u0026gt; \u0026lt;build\u0026gt; \u0026lt;plugins\u0026gt; \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-maven-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;/plugins\u0026gt; \u0026lt;/build\u0026gt; \u0026lt;/project\u0026gt; ä¸»ç±»ï¼ˆ~/user-service/src/main/java/com/example/user/UserServiceApplication.javaï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 package com.example.user; import org.springframework.boot.SpringApplication; import org.springframework.boot.autoconfigure.SpringBootApplication; import org.springframework.cloud.client.discovery.EnableDiscoveryClient; @SpringBootApplication @EnableDiscoveryClient public class UserServiceApplication { public static void main(String[] args) { SpringApplication.run(UserServiceApplication.class, args); } } å®ä½“ç±»ï¼ˆ~/user-service/src/main/java/com/example/user/entity/User.javaï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 package com.example.user.entity; import jakarta.persistence.Entity; import jakarta.persistence.GeneratedValue; import jakarta.persistence.GenerationType; import jakarta.persistence.Id; @Entity public class User { @Id @GeneratedValue(strategy = GenerationType.IDENTITY) private Long id; private String username; private String password; public Long getId() { return id; } public void setId(Long id) { this.id = id; } public String getUsername() { return username; } public void setUsername(String username) { this.username = username; } public String getPassword() { return password; } public void setPassword(String password) { this.password = password; } } ä»“åº“æ¥å£ï¼ˆ~/user-service/src/main/java/com/example/user/repository/UserRepository.javaï¼‰ï¼š\n1 2 3 4 5 6 7 package com.example.user.repository; import com.example.user.entity.User; import org.springframework.data.jpa.repository.JpaRepository; public interface UserRepository extends JpaRepository\u0026lt;User, Long\u0026gt; { } æ§åˆ¶å™¨ï¼ˆ~/user-service/src/main/java/com/example/user/controller/UserController.javaï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 package com.example.user.controller; import com.example.user.entity.User; import com.example.user.repository.UserRepository; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.http.ResponseEntity; import org.springframework.web.bind.annotation.PostMapping; import org.springframework.web.bind.annotation.RequestBody; import org.springframework.web.bind.annotation.RequestMapping; import org.springframework.web.bind.annotation.RestController; @RestController @RequestMapping(\u0026#34;/api/users\u0026#34;) public class UserController { @Autowired private UserRepository userRepository; @PostMapping public ResponseEntity\u0026lt;String\u0026gt; addUser(@RequestBody UserDTO userDTO) { User user = new User(); user.setUsername(userDTO.getUsername()); user.setPassword(userDTO.getPassword()); userRepository.save(user); return ResponseEntity.ok(\u0026#34;ç”¨æˆ·æ·»åŠ æˆåŠŸ\u0026#34;); } public static class UserDTO { private String username; private String password; public String getUsername() { return username; } public void setUsername(String username) { this.username = username; } public String getPassword() { return password; } public void setPassword(String password) { this.password = password; } } } é…ç½®æ–‡ä»¶ï¼ˆ~/user-service/src/main/resources/application.ymlï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 server: port: 8082 spring: application: name: user-service datasource: url: jdbc:h2:mem:userdb driver-class-name: org.h2.Driver username: sa password: jpa: database-platform: org.hibernate.dialect.H2Dialect hibernate: ddl-auto: update eureka: client: service-url: defaultZone: http://eureka-service:8761/eureka/ æ­¥éª¤ 2ï¼šæ„å»º Docker é•œåƒ 2.1 Eureka Server Dockerfile åœ¨ ~/eureka-server ä¸‹åˆ›å»º Dockerfileï¼š\n1 2 3 4 5 FROM openjdk:17-jdk-slim WORKDIR /app COPY target/eureka-server-0.0.1-SNAPSHOT.jar app.jar EXPOSE 8761 ENTRYPOINT [\u0026#34;java\u0026#34;, \u0026#34;-jar\u0026#34;, \u0026#34;app.jar\u0026#34;] æ„å»ºï¼š\n1 2 3 cd ~/eureka-server mvn clean package docker build -t eureka-server:latest . 2.2 Admin Service Dockerfile åœ¨ ~/admin-service ä¸‹åˆ›å»º Dockerfileï¼š\n1 2 3 4 5 FROM openjdk:17-jdk-slim WORKDIR /app COPY target/admin-service-0.0.1-SNAPSHOT.jar app.jar EXPOSE 8081 ENTRYPOINT [\u0026#34;java\u0026#34;, \u0026#34;-jar\u0026#34;, \u0026#34;app.jar\u0026#34;] æ„å»ºï¼š\n1 2 3 cd ~/admin-service mvn clean package docker build -t admin-service:latest . 2.3 User Service Dockerfile åœ¨ ~/user-service ä¸‹åˆ›å»º Dockerfileï¼š\n1 2 3 4 5 FROM openjdk:17-jdk-slim WORKDIR /app COPY target/user-service-0.0.1-SNAPSHOT.jar app.jar EXPOSE 8082 ENTRYPOINT [\u0026#34;java\u0026#34;, \u0026#34;-jar\u0026#34;, \u0026#34;app.jar\u0026#34;] æ„å»ºï¼š\n1 2 3 cd ~/user-service mvn clean package docker build -t user-service:latest . 2.4 éªŒè¯é•œåƒ 1 docker images æ­¥éª¤ 3ï¼šKubernetes éƒ¨ç½² åœ¨ ~/ ä¸‹åˆ›å»º k8s-deployments.ymlï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 apiVersion: v1 kind: Service metadata: name: eureka-service spec: selector: app: eureka ports: - protocol: TCP port: 8761 targetPort: 8761 type: NodePort --- apiVersion: apps/v1 kind: Deployment metadata: name: eureka-deployment spec: replicas: 1 selector: matchLabels: app: eureka template: metadata: labels: app: eureka spec: containers: - name: eureka image: eureka-server:latest imagePullPolicy: Never ports: - containerPort: 8761 env: - name: EUREKA_INSTANCE_HOSTNAME value: \u0026#34;eureka-service\u0026#34; --- apiVersion: v1 kind: Service metadata: name: admin-service spec: selector: app: admin ports: - protocol: TCP port: 8081 targetPort: 8081 type: NodePort --- apiVersion: apps/v1 kind: Deployment metadata: .observe name: admin-deployment spec: replicas: 1 selector: matchLabels: app: admin template: metadata: labels: app: admin spec: containers: - name: admin image: admin-service:latest imagePullPolicy: Never ports: - containerPort: 8081 env: - name: EUREKA_CLIENT_SERVICEURL_DEFAULTZONE value: \u0026#34;http://eureka-service:8761/eureka/\u0026#34; --- apiVersion: v1 kind: Service metadata: name: user-service spec: selector: app: user ports: - protocol: TCP port: 8082 targetPort: 8082 type: NOdePost --- apiVersion: apps/v1 kind: Deployment metadata: name: user-deployment spec: replicas: 1 selector: matchLabels: app: user template: metadata: labels: app: user spec: containers: - name: user image: user-service:latest imagePullPolicy: Never ports: - containerPort: 8082 env: - name: EUREKA_CLIENT_SERVICEURL_DEFAULTZONE value: \u0026#34;http://eureka-service:8761/eureka/\u0026#34; éƒ¨ç½² 1 kubectl apply -f ~/k8s-deployments.yml éªŒè¯ æ£€æŸ¥ Podï¼š\n1 kubectl get pods ç¡®è®¤ eureka-deployment-*ã€admin-deployment-* å’Œ user-deployment-* ä¸º Runningã€‚\næ£€æŸ¥æœåŠ¡ï¼š\n1 kubectl get services è®¿é—® Eureka ä»ªè¡¨æ¿ï¼š\n1 minikube service eureka-service --url åœ¨æµè§ˆå™¨æ‰“å¼€è¿”å›çš„ URLï¼Œç¡®è®¤æœåŠ¡æ³¨å†Œã€‚\næ­¥éª¤ 4ï¼šæµ‹è¯• API æš´éœ² Admin Serviceï¼š\n1 minikube service admin-service --url æµ‹è¯•æ·»åŠ ç”¨æˆ·ï¼š\n1 curl -X POST http://\u0026lt;admin-service-url\u0026gt;:8081/api/admin/users -H \u0026#34;Content-Type: application/json\u0026#34; -d \u0026#39;{\u0026#34;username\u0026#34;:\u0026#34;testuser\u0026#34;,\u0026#34;password\u0026#34;:\u0026#34;testpass\u0026#34;}\u0026#39; åº”è¿”å› ç”¨æˆ·æ·»åŠ æˆåŠŸã€‚\næµ‹è¯•å¤±è´¥æƒ…å†µï¼š\n1 curl -X POST http://\u0026lt;admin-service-url\u0026gt;:8081/api/admin/users -H \u0026#34;Content-Type: application/json\u0026#34; -d \u0026#39;{\u0026#34;username\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;password\u0026#34;:\u0026#34;testpass\u0026#34;}\u0026#39; åº”è¿”å› ç”¨æˆ·åæˆ–å¯†ç ä¸èƒ½ä¸ºç©ºã€‚\n","date":"0001-01-01T00:00:00Z","permalink":"https://ztsCream.github.io/p/","title":""}]